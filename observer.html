<!--
	Minion The Chacha Slayer v0.01
	
-->
<html>
<head>
	<title>Minion The Chacha Slayer v0.01</title>
	<!--[if IE]>
		<script type="text/javascript" src="./libraries/HTML5_Compatability/excanvas.js"></script>
	<![endif]-->
	<script type="text/javascript" src="./libraries/kinetic-v4.5.4.min.js"></script>
	<script src="jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="functions.js"></script>
	<style>
		  body {
        margin: 0px;
        padding: 0px;
      }
    	/*#container {
        background-color: #222;
        display: inline-block;
        width: 580px;
        height: 202px;
      }*/
      #buttons {
        position: absolute;
        top: 5px;
        left: 10px;        
      }

      #chat {
        position: absolute;
        top: 257px;
    		left: 10px;       
      }

      #buttons input {
      	min-width: 71px;
    		min-height: 26px;
      }
      /* incase you wana add additional buttons */
      #buttons > input {
        padding: 5px;
        display: block;
        margin-top: 5px;
      }

      #error {
        color:red;
      }
	</style>
</head>
<body>
<div style="float:left;" id="container" ></div>
<div style="float:left;" id="error" ></div>
<div style="float:left;" id="messagecontainer" >null</div>
<div style="float:left;" id="debugcontainer" >null</div>
<div style="clear:left;float:left;" id="chatcontainer" ></div>
<div id="buttons">
	<input type="button" id="headbutt" value="Head Butt">
	<input type="button" id="punch" value="Punch">
	<input type="button" id="mleft" value="Move Left">
	<input type="button" id="mright" value="Move Right">
  <input type="button" id="mjump" value="Jump">
	<input type="button" id="addparticle" value="Add Poring">
  <input type="button" id="adduser" value="Add User">
</div>
<div id="chat">
	<input type="text" id="chatm" />
	<input type="button" id="mmessage" value="message">
</div>
<script type="text/javascript" src="http://l2.io/ip.js?var=myip"></script>
<script type="text/javascript" defer="defer">
  var socket = io.connect( 'http://' + document.location.host );                  
  var name = '';

  window.onerror = function( message, lineno, filename ) { 
    document.getElementById('error').textContent = [
      'ERROR: Line ', lineno, ' in ', filename, ': ', message
    ].join('');
    // location.href = location.href;
  };
  
  window.onload = function() {
    socket.emit( 'logon', { myip: myip });

    socket.on( 'logon', function(e) {
        console.log( 'logon: ' + e.un );
        // name = e.un;
        name = e.un + Math.random();
        loadall();
    });

    socket.on( 'error', function(){
      console.log( 'error' ); 
      location.href = "index.html"; 
    });

  }

  function loadall() {
    
    socket.on( 'message', function(e) {
      console.log(e.msg) ;
      act( e.msg );
    });

    // create the stage
    var stage = new Kinetic.Stage({
      container: 'container',
      width: 600,
      height: 400
    });

    // characters container
    var blob = [];     // sprite image and position
    var blobname = []; // name under character
    var names = [];    // player names
    var chatboxText = []; // inside chat box
    var chatbox = []; //chat box    

    // layers to contain things  
    var Particlelayer = new Kinetic.Layer();
    var layer = new Kinetic.Layer();

    // animation reference
    var animations = {
      idle: [{
        x: 0,
        y: 0,
        width: 100,
        height: 100
      }, {
        x: 100,
        y: 0,
        width: 100,
        height: 100
      }, {
        x: 200,
        y: 0,
        width: 100,
        height: 100
      }, {
        x: 300,
        y: 0,
        width: 100,
        height: 100
      }, {
        x: 400,
        y: 0,
        width: 100,
        height: 100
      }, {
        x: 500,
        y: 0,
        width: 100,
        height: 100
      }, {
        x: 600,
        y: 0,
        width: 100,
        height: 100
      }],
      punch: [{
        x: 0,
        y: 100,
        width: 100,
        height: 100
      }, {
        x: 100,
        y: 100,
        width: 100,
        height: 100
      }, {
        x: 200,
        y: 100,
        width: 100,
        height: 100
      }],
      headbutt: [{
        x: 0,
        y: 200,
        width: 100,
        height: 100
      }, {
        x: 100,
        y: 200,
        width: 100,
        height: 100
      }, {
        x: 200,
        y: 200,
        width: 100,
        height: 100
      }]
    };

    function addUser( nchar ) {

      // check if it exist, if not add player    
      if( names[ nchar ] != nchar ) {

        //add player
        names[ nchar ] = nchar; 

        // image    
        var imageObj = new Image();
        blob[ nchar ] = new Kinetic.Sprite({
          x: Math.random() * stage.getWidth(),
          y: stage.getHeight() - 200,
          image: imageObj,
          width: 100,
          height: 25,
          animation: 'idle',
          animations: animations,
          frameRate: 20,
          index: 0
        });       
        
        imageObj.src = './img_1329409751_1.png';

        // add the shape to the layer
        layer.add(blob[ nchar ]);

        // start sprite animation
        blob[ nchar ].start();

        blobname[nchar] = new Kinetic.Text({
          x: blob[nchar].getX(),
          y: blob[nchar].getY() + blob[nchar].getHeight() + 90,
          text: nchar,
          fontSize: 17,
          width: 200,
          fontFamily: 'Calibri',
          fill: 'black'        
        });

        // name under your character  
        Particlelayer.add(blobname[nchar]);

        // bubble chat text
         chatboxText[nchar] = new Kinetic.Text({
          x: blob[nchar].getX(),
          y: blob[nchar].getY() - 30,
          text: 'chat box',
          fontSize: 11,
          fontFamily: 'Calibri',
          fill: 'black',
          width: 100,
          padding: 10,
          align: 'center'
        });

        // bubble chat container
        chatbox[nchar] = new Kinetic.Rect({
          x: blob[nchar].getX(),
          y: blob[nchar].getY() - 30,
          fill: 'white',
          stroke: 'black',
          strokeWidth: 1,
          width: 100,
          height: chatboxText[nchar].getHeight()
        });

        hidechatbox( nchar );

        // add the chatbox to the layer
        Particlelayer.add(chatbox[nchar]);  
        Particlelayer.add(chatboxText[nchar]);

      }

    }
    
    addUser( name );

    // add the layer to the stage  
    stage.add(layer);

    function speak( )
    {
      var message = document.getElementById('chatm').value;
      document.getElementById('chatm').value = '';
      showchatbox( message, name );
      csend( 'them', 'msg:' + message );
    }

    // Controls via mouse 
    document.getElementById('headbutt').addEventListener('click', function () {
      headbutt( blob[name] );
      csend( 'them', 'headbutt' );
    }, false);

    document.getElementById('punch').addEventListener('click', function () {
      punch( blob[name] );
      csend( 'them', 'punch' );
    }, false);

    document.getElementById('mleft').addEventListener('click', function () {
      left( blob[name] );
    }, false);

    document.getElementById('mright').addEventListener('click', function () {
      right( blob[name] );
    }, false);

    document.getElementById('mjump').addEventListener('click', function () {
      jump( blob[name] );
    }, false);

    document.getElementById('mmessage').addEventListener('click', function () {
      speak( );
    }, false);

    document.getElementById('addparticle').addEventListener('click', function () {
      addParticle( );
    }, false);

    document.getElementById('adduser').addEventListener('click', function () {
      addUser( document.getElementById('chatm').value );
    }, false);

    
    // Controls via keyboard 
    document.onkeydown = checkKey;
    document.onkeyup = checkKey_u;

    var left_button = false;
    var right_button = false;
    var last_key = null;
    var cf = false;

    function checkKey(e) 
    {
      e = e || window.event;
      last_key = e.keyCode;
      //space
      if(e.keyCode=='13')
      {
          cf = !cf;
          if(cf) {          
            document.getElementById('chatm').focus();          
          }
          else {
            speak( );
            document.getElementById('chatm').blur();
          }
      }
      
      if( !cf ) //if not in message input field
      { 
        if(e.keyCode=='32')
        {
            jump( blob[name] );  //code
        }
        else if(e.keyCode=='90')
        {
            punch( blob[name] );  //code
            csend( 'them', 'headbutt' );
        }
        else if(e.keyCode=='88')
        {
            headbutt( blob[name] );  //code
            csend( 'them', 'punch' );
        }
        else if(e.keyCode=='37' || e.keyCode=='65')
        {
            left_button = true;
        }
        else if(e.keyCode=='39' || e.keyCode=='68')
        {
            right_button = true;
        }
      }   

    }

    function checkKey_u(e) 
    {
      e = e || window.event;

      if(e.keyCode=='37' || e.keyCode=='65')
      {
          left_button = false;
      }
      else if(e.keyCode=='39' || e.keyCode=='68')
      {
          right_button = false;
      }
      
    }  

    function movechatbox( mcharacter, mchar ) {
    	chatboxText[ mchar ].setX( mcharacter.getX() );
    	chatbox[ mchar ].setX( mcharacter.getX() );
    	chatboxText[ mchar ].setY( mcharacter.getY() - 30 );
    	chatbox[ mchar ].setY( mcharacter.getY() - 30 );
    }

    function hidechatbox( mchar ) {
    	chatboxText[ mchar ].setText( '' );
    	chatboxText[ mchar ].hide();
    	chatbox[ mchar ].hide();
    }    

    function showchatbox( message, mchar ) {  
      addChatC( mchar, message );  
      chatboxText[ mchar ].setText( message );
      chatboxText[ mchar ].show();
      chatbox[ mchar ].show();
    	setTimeout( function(){ hidechatbox( mchar ) }, 750 );
    }  

    var amplitude = 150;
    var period = 2000;
    // in ms
    var centerX = stage.getWidth() / 2;
  	
  	particles = [];
    dot = [];
  	NUM_PARTICLES = 1;    

    function addParticle() {
      i = particles.length;
      particles[i] = new Particle( stage );
      dot[i] = new Kinetic.Image({
        x: particles[i].x,
        y: particles[i].y,
        image: imageObj,
        width: 50,
        height: 56
      });
     
      Particlelayer.add(dot[i]);
    }

    var imageObj = new Image();
    imageObj.onload = function() {
    	for(var i = 0; i < NUM_PARTICLES; i++) {
    		addParticle();
    	}
    }

    imageObj.src = './images/poring.png';
      
    stage.add(Particlelayer);

    var time  = 0,
        timeDiff  = 0,
        frameRate = 0,
        frps = 0;

    // breath animation     
    var breathDir = 1;
    var breathAmt = 0;    
    var breathInterval = setInterval( updateBreath, 1000 / frameRate );

    function updateBreath() { 
      if (breathDir === 1) {  
        // breath in        
        breathAmt -= 0.09;
        if ( breathAmt < -0.5 ) {
          breathDir = -1;
        }
      } 
      else {  
        // breath out
        breathAmt += 0.09;
        if( breathAmt > 0.5 ) {
          breathDir = 1;
        }
      }
    }
    
    var anim = new Kinetic.Animation(function (frame) {
        time = frame.time,
        timeDiff = frame.timeDiff,
        frameRate = frame.frameRate;

       // cycle through particles
       for(var i = 0; i < particles.length; i++) {        

          var clsn = false;

          for( item in names ) {
            // check every blob for collision
            if( check_collision( blob[ item ], dot[i] ) ) {
              clsn = true; 
            }
          }

          // for( item in particles ) {
          //   // check every particle except itself for collision
          //   if( check_collision( dot[ item ], dot[i] ) && item != i ) {
          //     clsn = true; 
          //   }
          // }

          if( clsn ) { 
            // collision once per particle 
            if( particles[i].lc == particles[i].cc ) {          
              particles[i].xvel = -particles[i].xvel;
              particles[i].yvel = -particles[i].yvel;
              particles[i].cc = !particles[i].cc;            
            }            
          } else {
            particles[i].lc = particles[i].cc;            
          }

          particles[i].update( stage );
          
          dot[i].setX( particles[i].x );
          dot[i].setY( particles[i].y );
          dot[i].setWidth( dot[i].getWidth() - breathAmt );
          dot[i].setHeight( dot[i].getHeight() - breathAmt );        

       }

       if(left_button)
          left( blob[name] );
       if(right_button)
          right( blob[name] );            

      for( item in names ) {
        blobname[ item ].setText( item );                
        blobname[ item ].setX(blob[item].getX());
        blobname[ item ].setY(blob[item].getY() + blob[item].getHeight() + 110);
      }

      for( item in names ) {
        movechatbox( blob[ item ], item ); 
      }
      
      // easy debug but hard to read
      var debug = 'param:';
      for( item in particles[0] ) {
        if( !isFunction( particles[0][item] ) ) {
          debug += '<br> ' + item + ':' + particles[0][item];
        }
      }      
            
      document.getElementById('debugcontainer').innerHTML = debug;      
    }, Particlelayer);

    anim.start();
    
    // reciever
    var cp    = 0;
    var pps   = 0

    setInterval( function() { 
      pps = cp;
      frps = frameRate.toFixed(2);
      cp = 0;
    }, 1000 );

    var getres = 'null'; 
    
    setInterval( function() {
        // retriever 
        // return name:action:text\n\nname:action:text\n\nname:action:text      
        csend( 'all', 'pos:' + blob[name].getX() + ',' + blob[name].getY() );
    }, 100);

    // send data to the server
    // syntax: csend( target, text )
    // target can be "all", "playername", "them"
    var cd = false;         
    function csend( target, action ) {  
      
      socket.emit( 'message', target, { action: action } );
      cp++; 
      getres = 'FrameRate: ' + frps + '<br>Latency: ' + pps + 'ms <br>Last key pressed: ' + last_key; 
      document.getElementById('messagecontainer').innerHTML = getres;          
    }

    function act( e ) {
      if(e=='undefined') return;
      // split message by Lines
      var lines = e.split("\n\n");

      for(var i = 0; i < lines.length; i++) {
        if( lines[i]=='' ) { 
          continue;
        }
        var colons = lines[i].split(":"); // split message by colons
        var user = colons[0];
        var action = colons[1];
        var data = colons[2];

        if( action == 'stat' ) {
          alert( data );
        } else if( action == 'msg' ) {        
          if( user != name ) { 
            showchatbox( data, user );
          }
        } else if ( action == 'add' ) {
          addUser( data );
        } else if ( action == 'pos' ) {
          // move everyone but yourself ( to not cause any control trouble)
          var cpos = data.split(",");
          if( user != name ) {  

            // set players position         
            blob[ user ].setX( cpos[0] * 1 );
            blob[ user ].setY( cpos[1] * 1 );

          }
        } else if ( action == 'punch' ) {
          if( user != name ) {  
            punch( blob[ user ] );
          }        
        } else if ( action == 'headbutt' ) {
          if( user != name ) {  
            headbutt( blob[ user ] );
          }
        }
      }    
    }

  }

</script>
</body>
</html>